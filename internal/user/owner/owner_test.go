package owner

import (
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func TestDecryptJWE_ShouldDecryptValidly(t *testing.T) {
	// given
	encryptedJWE := "eyJlbmMiOiJBMTI4R0NNIiwiYWxnIjoiZGlyIn0..914U_1q7qRgmah7-.4MqUDKtqo1CH2Y2JcFdsrelwHBBFOK0FJKXGqjwKCXo1XVgm0CuHDh6sBaDKDuDjtYtNW8Mrx_n7NPhWpchbL-ejwI8LWcS4VTBM0sVqMxgzNTckW2vbEXKTnTQlpF_-MIfLFANr5EskLFuUIpeZTBN_KZ5bqeMn5Uwjth0CXrQ6ec_2nSRnK7yMIShCRTjSiOBUhrT-d0tHQjbKXMpqyQ4GQYVwQ5g-wRT7vsOpBBZmw5YpuSeL32ZD7Ltl_bnKAWkis55Uj2nu6oCZN-chqMDDetHjuHYGRSf4GbrGB2mJ_T7EzUjyHVrtAUS6ZYaLTglcrwH1TZ3dIv0oeexDECfrJjvAP_VcNXmgP5OB6_kS937wquuoNgnjTNnMvL9QGNfIbUW4tL7QcGyjJ4ynQcheWAIUPu9Y73Se-9ecDnAr_Tq83EKWUFFyhQb_lTxULtRQ5GqrC-vYeIXy63BsJqSUwr1hPNXP6Pm3_IJzwK4HtjyZWwQzxH3gBogDhP39MB5eRCkUPHaMyLyGZ1PYEUlrXabZp0BsxIDqK6sWlNj0JP63diHb8INLR7ysGD2SMOzsuxfhJtzCnK2SHK5hNOSXpcDYd1mWcKz1lh_iCPk--AYqGX27r2Doa06jFDqeMt31zrulDbwwQgW-_wKtY6VRk-Yb-M8_Dpy-qZFt1GzTObYCa9ovIFqDbt5hUPa_e2EYBesGoDHG4GXz_e4d4ACObJSSxCBt0s9ywgviw-7Oc6aRy6z8u_bqrY315kbQcRI4mFLgWPHgHDZOtEbJDxk-uXdg0DlrecMh2VP1Gfn3JUVCy3TUlc_f-grnQfUWgMrcI0c1jx49rzoVBx7sg0o1jzwQyozYRwKWekS2r-Xi3z1218yfwFNYImaaJgvjbooyvb_gMD3H2Gd6nktLS9hEpaUvJ4rhNiFNgsYuBSg4Pv6u9DPsZyeUDUcUBhX_oh931IVaZj81ZPkfSLuiHWwpNAkhA6KAqn0xl8MSBOMakcY6hZfDSGQwdBBIaCGq_ryRRTDP26Y8LeOt0Kny5qP-b7RcHsiR0gfvrrfqWBE9u9jiMvR5mOnGUKHegSjQpyrSbQO-y-GrX5a_r4_fPWNzyWHXhq88-KfqEegdSxEU4TR4ji2hD1ofhvCQFXstjT6B96YyLxN9855yUzZCjCSFbJ2MVpAnIoVlTiLtLBRTSqkfOI58S5XLw_Bgx98C6cD13XuTs30VnKf28_bDxkyuGqezrTVBjRSSjmKma8KzOpD_97ZO9EZkr2AT5MerN4-_gCbhxthL19HB-RnPHhMHf04KTLmfqojfLeljOobSRMpPkA.X-BZvdm7Nw48ckMrX2cWnA"
	expectedClaims := &RegisterJWEClaims{
		JWS: "eyJhbGciOiJSUzI1NiJ9.eyJwdWJsaWNLZXkiOiItLS0tLUJFR0lOIFJTQSBQVUJMSUMgS0VZLS0tLS1cbk1JSUJDZ0tDQVFFQXRUM2dKQXp2ck5kNHlrTE5GRlN2ZHQvc2owUGpZL3ZmY3R2a003MExWL01rSGZIQTZ2NExcbmdpS3E2TEdYMFlHVERiS0cyRG5hc2JqS3ZwelhDQlR1YnBlUXl4TnI4QnNUL25sVmZQajBRRTZOa2NGcVVqTGVcbkUvaWZldFlwUUtkb1VQRllkSXdUZGZkV3pIN1g4OHIvRkJpSFdZakY1NDEydDVCek9mQkZYMEhoNlpJbkl3clVcbktKZUpBVXljZXFVbGdOWkE0b3k4YkR4TjZkNmdFeHZuYmlOa1lLdzJVN2ZWc25CSzlpajZiSjJYWmRBSlV6TEZcbk1MUWc0SW5LeXB5RzNXVitSZXlKQzlFY0p5NnRuZk82NHJtd0tlQTl1a2J1aXFva1laM2I1NE5pMkZTVGdaaUdcbno2aVBXMURqWFg5WXhSSVNoTHpZMkJzazU4dHVUWUdTMXdJREFRQUJcbi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS1cbiIsImlhdCI6MTc1MjE1NDkzN30.LLD-jQJmw3oEX-RYv8bO0wW5aG3FkeIlTU9lq17nPtXWB9Ino5kzrBKU8Dm8RcD3juj2HA-bfo8_fNj8TW2Xvt1yPQqanIxfL2q0t4aNroysel9Ue2A6ctr5dFDQE2UINzNa8t6kZM6Stdgz5FGhOKbS-3ZmYcKNdAD182-uJwgD3MEbFIEvfoGYbTdx5E3BulJWEDLnuWZpnmm1p4oZ83pEUuOYC8h6jD2PBPEBrPSeGK9ojCV6n6JkOk6nASzn0SSZycoKhyrG7efy3emC4s6QbHIa47ehVARMIOyl4SaNBG3u9E_-AnVT5MHm13Hmhz8BaVEOsvmnOgltqPWXSg",
	}
	masterPasswordHash := "086c846547fd8a5750fb8ea740c5e6bb"

	// when
	actualClaims, err := DecryptJWE(encryptedJWE, masterPasswordHash)

	// then
	assert.NoError(t, err)
	assert.Equal(t, expectedClaims, actualClaims)
}

func TestDecryptJWE_ShouldNotDecryptValidlyIfWrongPasswordUsed(t *testing.T) {
	// given
	encryptedJWE := "eyJlbmMiOiJBMTI4R0NNIiwiYWxnIjoiZGlyIn0..914U_1q7qRgmah7-.4MqUDKtqo1CH2Y2JcFdsrelwHBBFOK0FJKXGqjwKCXo1XVgm0CuHDh6sBaDKDuDjtYtNW8Mrx_n7NPhWpchbL-ejwI8LWcS4VTBM0sVqMxgzNTckW2vbEXKTnTQlpF_-MIfLFANr5EskLFuUIpeZTBN_KZ5bqeMn5Uwjth0CXrQ6ec_2nSRnK7yMIShCRTjSiOBUhrT-d0tHQjbKXMpqyQ4GQYVwQ5g-wRT7vsOpBBZmw5YpuSeL32ZD7Ltl_bnKAWkis55Uj2nu6oCZN-chqMDDetHjuHYGRSf4GbrGB2mJ_T7EzUjyHVrtAUS6ZYaLTglcrwH1TZ3dIv0oeexDECfrJjvAP_VcNXmgP5OB6_kS937wquuoNgnjTNnMvL9QGNfIbUW4tL7QcGyjJ4ynQcheWAIUPu9Y73Se-9ecDnAr_Tq83EKWUFFyhQb_lTxULtRQ5GqrC-vYeIXy63BsJqSUwr1hPNXP6Pm3_IJzwK4HtjyZWwQzxH3gBogDhP39MB5eRCkUPHaMyLyGZ1PYEUlrXabZp0BsxIDqK6sWlNj0JP63diHb8INLR7ysGD2SMOzsuxfhJtzCnK2SHK5hNOSXpcDYd1mWcKz1lh_iCPk--AYqGX27r2Doa06jFDqeMt31zrulDbwwQgW-_wKtY6VRk-Yb-M8_Dpy-qZFt1GzTObYCa9ovIFqDbt5hUPa_e2EYBesGoDHG4GXz_e4d4ACObJSSxCBt0s9ywgviw-7Oc6aRy6z8u_bqrY315kbQcRI4mFLgWPHgHDZOtEbJDxk-uXdg0DlrecMh2VP1Gfn3JUVCy3TUlc_f-grnQfUWgMrcI0c1jx49rzoVBx7sg0o1jzwQyozYRwKWekS2r-Xi3z1218yfwFNYImaaJgvjbooyvb_gMD3H2Gd6nktLS9hEpaUvJ4rhNiFNgsYuBSg4Pv6u9DPsZyeUDUcUBhX_oh931IVaZj81ZPkfSLuiHWwpNAkhA6KAqn0xl8MSBOMakcY6hZfDSGQwdBBIaCGq_ryRRTDP26Y8LeOt0Kny5qP-b7RcHsiR0gfvrrfqWBE9u9jiMvR5mOnGUKHegSjQpyrSbQO-y-GrX5a_r4_fPWNzyWHXhq88-KfqEegdSxEU4TR4ji2hD1ofhvCQFXstjT6B96YyLxN9855yUzZCjCSFbJ2MVpAnIoVlTiLtLBRTSqkfOI58S5XLw_Bgx98C6cD13XuTs30VnKf28_bDxkyuGqezrTVBjRSSjmKma8KzOpD_97ZO9EZkr2AT5MerN4-_gCbhxthL19HB-RnPHhMHf04KTLmfqojfLeljOobSRMpPkA.X-BZvdm7Nw48ckMrX2cWnA"
	invalidMasterPasswordHash := "8e8210c8d03064930e4ee7f2f1f6e2c2"

	// when
	actualClaims, err := DecryptJWE(encryptedJWE, invalidMasterPasswordHash)

	// then
	assert.Error(t, err)
	assert.Nil(t, actualClaims)
}

func TestVerifyJWS_ShouldVerifyValidly(t *testing.T) {
	// given
	jwsClaims := &RegisterJWEClaims{
		JWS: "eyJhbGciOiJSUzI1NiJ9.eyJwdWJsaWNLZXkiOiItLS0tLUJFR0lOIFJTQSBQVUJMSUMgS0VZLS0tLS1cbk1JSUJDZ0tDQVFFQXRUM2dKQXp2ck5kNHlrTE5GRlN2ZHQvc2owUGpZL3ZmY3R2a003MExWL01rSGZIQTZ2NExcbmdpS3E2TEdYMFlHVERiS0cyRG5hc2JqS3ZwelhDQlR1YnBlUXl4TnI4QnNUL25sVmZQajBRRTZOa2NGcVVqTGVcbkUvaWZldFlwUUtkb1VQRllkSXdUZGZkV3pIN1g4OHIvRkJpSFdZakY1NDEydDVCek9mQkZYMEhoNlpJbkl3clVcbktKZUpBVXljZXFVbGdOWkE0b3k4YkR4TjZkNmdFeHZuYmlOa1lLdzJVN2ZWc25CSzlpajZiSjJYWmRBSlV6TEZcbk1MUWc0SW5LeXB5RzNXVitSZXlKQzlFY0p5NnRuZk82NHJtd0tlQTl1a2J1aXFva1laM2I1NE5pMkZTVGdaaUdcbno2aVBXMURqWFg5WXhSSVNoTHpZMkJzazU4dHVUWUdTMXdJREFRQUJcbi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS1cbiIsImlhdCI6MTc1MjE1NDkzN30.LLD-jQJmw3oEX-RYv8bO0wW5aG3FkeIlTU9lq17nPtXWB9Ino5kzrBKU8Dm8RcD3juj2HA-bfo8_fNj8TW2Xvt1yPQqanIxfL2q0t4aNroysel9Ue2A6ctr5dFDQE2UINzNa8t6kZM6Stdgz5FGhOKbS-3ZmYcKNdAD182-uJwgD3MEbFIEvfoGYbTdx5E3BulJWEDLnuWZpnmm1p4oZ83pEUuOYC8h6jD2PBPEBrPSeGK9ojCV6n6JkOk6nASzn0SSZycoKhyrG7efy3emC4s6QbHIa47ehVARMIOyl4SaNBG3u9E_-AnVT5MHm13Hmhz8BaVEOsvmnOgltqPWXSg"}
	expectedClaims := &RegisterJWSClaims{
		IssuedAt:  1752154937,
		PublicKey: "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAtT3gJAzvrNd4ykLNFFSvdt/sj0PjY/vfctvkM70LV/MkHfHA6v4L\ngiKq6LGX0YGTDbKG2DnasbjKvpzXCBTubpeQyxNr8BsT/nlVfPj0QE6NkcFqUjLe\nE/ifetYpQKdoUPFYdIwTdfdWzH7X88r/FBiHWYjF5412t5BzOfBFX0Hh6ZInIwrU\nKJeJAUyceqUlgNZA4oy8bDxN6d6gExvnbiNkYKw2U7fVsnBK9ij6bJ2XZdAJUzLF\nMLQg4InKypyG3WV+ReyJC9EcJy6tnfO64rmwKeA9ukbuiqokYZ3b54Ni2FSTgZiG\nz6iPW1DjXX9YxRIShLzY2Bsk58tuTYGS1wIDAQAB\n-----END RSA PUBLIC KEY-----\n",
	}
	SetTimeNowFunc(func() time.Time {
		return time.Unix(1752154947, 0)
	})

	// when
	actualClaims, err := VerifyJWS(jwsClaims.JWS, 10)

	// then
	assert.NoError(t, err)
	assert.Equal(t, expectedClaims, actualClaims)
}

func TestVerifyJWS_ShouldNotVerifyWhenExpired(t *testing.T) {
	// given
	jwsClaims := &RegisterJWEClaims{
		JWS: "eyJhbGciOiJSUzI1NiIsInByb3BYIjpmYWxzZX0.eyJpYXQiOjE3Mzg1Mjk2NDEsInB1YmxpY0tleSI6Ii0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tXG5NSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXhsUFFleVdxYUhhMEM4WDNVU0VDXG42ZE5ZeTNiV3VHc1FWZnpTaHZpVHBlcHN3UjNoZUhOVXZWTktxdVhkdlpsOFJiQ3J2UWNaMDF2dkpTK2lBTW5QXG5qUnF4MjBLR282TnVwSEhaSWVhbUJHZUNPU1g0Nmt5bWdBRjZ2R3pzZDluUVJ6aGh6NHhHbGg1SXlTNkwxUDNNXG5NaDVPT3d1UXlXQUdxTjRWOWNtbGJab1RlWUVNRWJJUklLY2dsbHZpcEpmdWpUZmNaK3Y2VnJhcTIyd1VmekFpXG5lZ3ZBa3VmK0NONSt4TkpjMCtGZUpYTm5JRSt2UmxsaDluUStBaEVLK1p2dFpMZ1dYY2QzdzREWU9UVER4VGJlXG54cFY2K0ljR2N6QXQzb1lRV21hT3owNFJHOXFLejM3eG5jbW1pZnhDY1BzeHM2V3FNd0xxQnAvV1FqS2ZnWVZXXG5Dd0lEQVFBQlxuLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tIn0.dwG8IocXWuDfTfTUZfaNv-7dfA-FHZx6Ztox6MEnEaziTvnPZ_Js43V4rWaUOP_mxYHmQ0y357OIj0nVTwTAWvZGWPqM9ExGpFvSSTziSCICmu8pMbjW2Y2LEbesiR5eBnU1B7_GyUHmoOB6ums2Eb21pwv5HYYLsD8gF3SA1T1gO1ps-hdLLYYomP_BY_FdMO_DDUt6I7WyxVyEc3SG3mlxEllS2vO2WdF8XIpXnlJi3HCPKViS7-NwpCVSMpQhb-YpLMg_gELFF7Gqu-WxVsK7R0Ntnx9wgHShAtnDCdoHUi743XIUH7P2Cb0_xUdG3lQp0761g0hiNaqbtuYE_Q",
	}
	SetTimeNowFunc(func() time.Time {
		return time.Unix(1738529844, 0)
	})

	// when
	actualClaims, err := VerifyJWS(jwsClaims.JWS, 10)

	// then
	assert.Error(t, err)
	assert.Nil(t, actualClaims)
}

func TestExtractJWEFromAuthorizationHeader_ShouldExtractValidly(t *testing.T) {
	// given
	authHeader := "Bearer eyJlbmMiOiJBMTI4R0NNIiwiYWxnIjoiZGlyIn0..914U_1q7qRgmah7-.4MqUDKtqo1CH2Y2JcFdsrelwHBBFOK0FJKXGqjwKCXo1XVgm0CuHDh6sBaDKDuDjtYtNW8Mrx_n7NPhWpchbL-ejwI8LWcS4VTBM0sVqMxgzNTckW2vbEXKTnTQlpF_-MIfLFANr5EskLFuUIpeZTBN_KZ5bqeMn5Uwjth0CXrQ6ec_2nSRnK7yMIShCRTjSiOBUhrT-d0tHQjbKXMpqyQ4GQYVwQ5g-wRT7vsOpBBZmw5YpuSeL32ZD7Ltl_bnKAWkis55Uj2nu6oCZN-chqMDDetHjuHYGRSf4GbrGB2mJ_T7EzUjyHVrtAUS6ZYaLTglcrwH1TZ3dIv0oeexDECfrJjvAP_VcNXmgP5OB6_kS937wquuoNgnjTNnMvL9QGNfIbUW4tL7QcGyjJ4ynQcheWAIUPu9Y73Se-9ecDnAr_Tq83EKWUFFyhQb_lTxULtRQ5GqrC-vYeIXy63BsJqSUwr1hPNXP6Pm3_IJzwK4HtjyZWwQzxH3gBogDhP39MB5eRCkUPHaMyLyGZ1PYEUlrXabZp0BsxIDqK6sWlNj0JP63diHb8INLR7ysGD2SMOzsuxfhJtzCnK2SHK5hNOSXpcDYd1mWcKz1lh_iCPk--AYqGX27r2Doa06jFDqeMt31zrulDbwwQgW-_wKtY6VRk-Yb-M8_Dpy-qZFt1GzTObYCa9ovIFqDbt5hUPa_e2EYBesGoDHG4GXz_e4d4ACObJSSxCBt0s9ywgviw-7Oc6aRy6z8u_bqrY315kbQcRI4mFLgWPHgHDZOtEbJDxk-uXdg0DlrecMh2VP1Gfn3JUVCy3TUlc_f-grnQfUWgMrcI0c1jx49rzoVBx7sg0o1jzwQyozYRwKWekS2r-Xi3z1218yfwFNYImaaJgvjbooyvb_gMD3H2Gd6nktLS9hEpaUvJ4rhNiFNgsYuBSg4Pv6u9DPsZyeUDUcUBhX_oh931IVaZj81ZPkfSLuiHWwpNAkhA6KAqn0xl8MSBOMakcY6hZfDSGQwdBBIaCGq_ryRRTDP26Y8LeOt0Kny5qP-b7RcHsiR0gfvrrfqWBE9u9jiMvR5mOnGUKHegSjQpyrSbQO-y-GrX5a_r4_fPWNzyWHXhq88-KfqEegdSxEU4TR4ji2hD1ofhvCQFXstjT6B96YyLxN9855yUzZCjCSFbJ2MVpAnIoVlTiLtLBRTSqkfOI58S5XLw_Bgx98C6cD13XuTs30VnKf28_bDxkyuGqezrTVBjRSSjmKma8KzOpD_97ZO9EZkr2AT5MerN4-_gCbhxthL19HB-RnPHhMHf04KTLmfqojfLeljOobSRMpPkA.X-BZvdm7Nw48ckMrX2cWnA"

	// when
	jwe, err := ExtractJWEFromAuthorizationHeader(authHeader)

	// then
	assert.NoError(t, err)
	assert.NotEmpty(t, jwe)
	assert.Contains(t, jwe, "eyJlbmMiOiJBMTI4R0NNIiwiYWxnIjoiZGlyIn0")
}

func TestExtractJWEFromAuthorizationHeader_ShouldFailWithInvalidFormat(t *testing.T) {
	// given
	authHeader := "InvalidFormat"

	// when
	jwe, err := ExtractJWEFromAuthorizationHeader(authHeader)

	// then
	assert.Error(t, err)
	assert.Empty(t, jwe)
}
